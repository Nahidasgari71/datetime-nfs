
# üïí Datetime Service with NFS Shared Volume

This project demonstrates a simple microservice-style setup where a **Flask** app generates timestamped `.html` files, stores them in a shared **NFS volume**, and serves them through **Nginx** acting as a reverse proxy.

---

## üìÅ Project Structure

```
.
‚îú‚îÄ‚îÄ app.py                 # Flask app to display latest HTML files
‚îú‚îÄ‚îÄ docker-compose.yml     # Defines Flask + Nginx + NFS stack
‚îú‚îÄ‚îÄ Dockerfile             # Builds the Flask image
‚îú‚îÄ‚îÄ generate_files.py      # Generates HTML file every minute
‚îú‚îÄ‚îÄ nginx.conf             # Nginx configuration
‚îú‚îÄ‚îÄ requirements.txt       # Python dependencies
‚îú‚îÄ‚îÄ .env                   # Environment variables
‚îî‚îÄ‚îÄ README.md              # This file
```

---

## ‚öôÔ∏è Technologies Used

- Docker & Docker Compose  
- Python 3.10 with Flask  
- Nginx as a Reverse Proxy  
- NFS (Network File System) for shared volumes  

---

## ‚öôÔ∏è Setup Instructions

### 1. Make Sure NFS Is Running on the Host

```bash
# Example on 192.168.100.3:
sudo mkdir -p /srv/nfs/files
sudo chown nobody:nobody /srv/nfs/files
echo "/srv/nfs/files *(rw,sync,no_subtree_check,no_root_squash)" | sudo tee -a /etc/exports
sudo exportfs -a
sudo systemctl restart nfs-server
```

### 2. Clone and Configure the Project

```bash
git clone https://example.com/your-project.git
cd datetime-nfs
cp .env.example .env  # or manually create and edit the .env file
```

### 3. Start the Services

```bash
docker compose up -d
```

---

## üåê Testing the Application

### 1. Access the Flask App

# shows links to the latest 5 HTML files:
- Visit: [http://localhost:5000](http://localhost:5000)

### 2. Access Files via Nginx

# shows file list from NFS volume:
- Visit: [http://localhost/files/](http://localhost/files/)

### 3. Check Files in Containers

```bash
docker exec -it flask ls /app/files
docker exec -it nginx ls /app/files
```

---

## üîê .env Configuration

| Variable             | Description                             |
|----------------------|-----------------------------------------|
| `FLASK_PORT`         | Flask service port (default: 5000)      |
| `NGINX_PORT`         | Nginx service port (default: 80)        |
| `NFS_SERVER_IP`      | IP address of the NFS host              |
| `NFS_SHARE_PATH`     | Exported path on the NFS server         |

---

## üîÑ File Generation Logic

```python
import os
import time
from datetime import datetime

FILE_DIR = "/app/files"
os.makedirs(FILE_DIR, exist_ok=True)

while True:
    timestamp = datetime.now().strftime("%y-%m-%dT%H-%M-%S")
    file_path = os.path.join(FILE_DIR, f"{timestamp}.html")

    with open(file_path, "w") as f:
        f.write(f"Generated by python at {timestamp}")

    files = sorted(os.listdir(FILE_DIR))
    while len(files) > 5:
        os.remove(os.path.join(FILE_DIR, files.pop(0)))

    time.sleep(60)
```


---

## üêû Common Issues & Fixes

|               Issue           |                                  Fix                                     |
|-------------------------------|--------------------------------------------------------------------------|
| Files not showing in Nginx    | Make sure NFS is mounted correctly. Restart containers after confirming. |
| Permission denied on NFS path | Set permissions to `chmod 777` and owner to `nobody:nogroup`.            |
| Old files disappear           | This is intentional ‚Äî only the latest 5 files are kept.                  |

---

## ‚úÖ CI/CD Pipeline (GitLab Example)

Here‚Äôs the `.gitlab-ci.yml` used for auto-deployment:

```yaml
stages:
  - build
  - deploy

build:
  stage: build
  script:
    - docker build -t myapp .

deploy:
  stage: deploy
  script:
    - docker compose down -v
    - docker compose up -d
```
